<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TechMeet | Meeting</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="css/index.css">
</head>
<body>

<header>
  <div class="logo">Tech<span>Meet</span></div>

  <div class="user-info">
    <img src="logo.jpg" alt="user">
    <button onclick="logout()">Logout</button>
  </div>
</header>

<main>

  <!-- VIDEO AREA -->
  <section class="video-area" id="videos">

    <!-- PRELOADED SANYA VIDEO (LIKE YOUR ORIGINAL FILE) -->
    <div class="video-box" data-user="Sanya (Co-Host)" data-user-id="sanya" id="sanyaVideoBox">
      <div class="simulated-video">Sanya Video Live</div>
    </div>

  </section>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">

    <!-- HOST ONLY -->
    <div class="meeting-code-box" id="hostCodeBox">
      <p>Meeting Code:</p>
      <div class="meeting-code" id="meetingCode">#CODE</div>
      <button class="share-btn" onclick="copyCode()">Share/Invite</button>
    </div>

    <div class="participants" id="hostParticipants">
      <h3>Participants <span id="participantCount">(Loading...)</span></h3>

      <ul id="usersList">

        <!-- HOST -->
        <li id="hostListItem" class="approved" data-user-id="host">
          <div class="participant-name-container">You (Host)</div>
        </li>

        <!-- SANYA (PRELOADED) -->
        <li data-status="approved" class="approved" data-user-id="sanya">
          <div class="participant-name-container">Sanya</div>
          <div class="participant-actions">
            <button class="mute-btn" onclick="toggleParticipantMic(this)" data-muted="false" data-user-id="sanya">
              <i class="fa-solid fa-microphone"></i>
            </button>
            <button class="kick-btn" onclick="kickUser(this)" data-user-id="sanya">
              <i class="fa-solid fa-user-minus"></i>
            </button>
          </div>
        </li>

        <!-- Pending Example Users -->
        <li data-status="pending" data-user-id="rahul">
          <div class="participant-name-container">Rahul</div>
          <div class="participant-actions">
            <button onclick="approveUser(this)">Approve</button>
            <button class="reject-btn" onclick="rejectUser(this)">Reject</button>
          </div>
        </li>

        <li data-status="pending" data-user-id="ananya">
          <div class="participant-name-container">Ananya</div>
          <div class="participant-actions">
            <button onclick="approveUser(this)">Approve</button>
            <button class="reject-btn" onclick="rejectUser(this)">Reject</button>
          </div>
        </li>

      </ul>
    </div>

    <!-- CHAT -->
    <div class="chat-section" id="chatSection">
      <div class="chat-header">
        <h3>Chat</h3>
        <button class="chat-toggle-btn" onclick="toggleChat()">
          <i class="fa-solid fa-xmark" id="chatToggleIcon"></i>
        </button>
      </div>

      <div class="chat-box" id="chatBox">
        <div class="msg sys">Welcome to the chat!</div>
      </div>

      <form id="chatForm" class="chatForm">
        <input type="text" id="chatInput" placeholder="Type a message..." required>
        <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
      </form>
    </div>

  </aside>
</main>

<!-- FOOTER CONTROLS -->
<footer id="footerControls">
  <div id="recordingTimer"><span class="dot"></span> <span id="timerDisplay">00:00</span></div>

  <div class="control" id="micControl"><i class="fa-solid fa-microphone"></i></div>
  <div class="control" id="videoControl"><i class="fa-solid fa-video"></i></div>

  <div class="control end-call-btn" id="endCallControl"><i class="fa-solid fa-phone-slash"></i></div>

  <div class="control" id="screenshotBtn"><i class="fa-solid fa-camera"></i></div>
  <div class="control" id="recordBtn"><i class="fa-solid fa-circle"></i></div>
</footer>

<!-- INVITE POPUP (HOST ONLY) -->
<div class="popup-overlay hidden" id="shareModal">
  <div class="popup-box">
    <span class="close-btn" onclick="hideShareModal()">&times;</span>
    <h2>Invite Participants</h2>
    <p>Share this meeting code:</p>
    <div class="meeting-code" id="modalMeetingCode">#CODE</div>
    <button class="popup-btn" onclick="copyCode()">Copy Code</button>
  </div>
</div>

<!-- TOAST NOTIFICATION -->
<div id="joinNotification" class="toast-notification hidden">
  <i class="fa-solid fa-check-circle"></i>
  <span></span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* =========================
   GLOBAL STATES
========================= */
let isMicMuted = false;
let isVideoOff = true;
let isHostMode = true;
let localStream;
let recorder, chunks = [];
let recordingTimerInterval;

/* =========================
   Get meeting mode (START/JOIN)
========================= */
window.onload = () => {
  const params = new URLSearchParams(location.search);
  const mode = params.get("mode");
  const code = params.get("code") || generateCode();

  document.getElementById("meetingCode").textContent = "#" + code;
  document.getElementById("modalMeetingCode").textContent = "#" + code;

  if (mode === "join") {
    isHostMode = false;

    // Remove host-only elements
    hostCodeBox.style.display = "none";
    hostParticipants.style.display = "none";
    recordBtn.style.display = "none";
    screenshotBtn.style.display = "none";

    sanyaVideoBox?.remove();
    hostListItem?.remove();
    document.querySelectorAll("#usersList li").forEach(li => li.remove());
  }

  getLocalStream().then(() => {
    updateMicControl();
    updateVideoControl();
  });
};

/* =========================
   Generate meeting code
========================= */
function generateCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

/* =========================
   MEDIA STREAM
========================= */
async function getLocalStream() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });

    localStream = stream;
    localStream.getVideoTracks()[0].enabled = !isVideoOff;
    localStream.getAudioTracks()[0].enabled = !isMicMuted;

    const box = document.createElement("div");
    box.className = "video-box speaking";
    box.id = "myVideoBox";
    box.dataset.user = isHostMode ? "You (Host)" : "You (Guest)";

    const video = document.createElement("video");
    video.srcObject = localStream;
    video.autoplay = true;
    video.muted = true;

    box.appendChild(video);
    videos.prepend(box);

  } catch (e) {
    alert("Permission denied for camera/mic");
  }
}

/* =========================
   MIC CONTROL
========================= */
micControl.onclick = () => {
  isMicMuted = !isMicMuted;
  updateMicControl();
};

function updateMicControl() {
  const icon = micControl.querySelector("i");
  localStream?.getAudioTracks().forEach(t => t.enabled = !isMicMuted);

  if (isMicMuted) {
    icon.className = "fa-solid fa-microphone-slash";
  } else {
    icon.className = "fa-solid fa-microphone";
  }
}

/* =========================
   VIDEO CONTROL
========================= */
videoControl.onclick = () => {
  isVideoOff = !isVideoOff;
  updateVideoControl();
};

function updateVideoControl() {
  const icon = videoControl.querySelector("i");
  const myVideo = document.querySelector("#myVideoBox video");

  localStream?.getVideoTracks().forEach(t => t.enabled = !isVideoOff);

  if (isVideoOff) {
    icon.className = "fa-solid fa-video-slash";
    myVideo.style.visibility = "hidden";
  } else {
    icon.className = "fa-solid fa-video";
    myVideo.style.visibility = "visible";
  }
}

/* =========================
   PARTICIPANT ACTIONS
========================= */
function approveUser(btn) {
  const li = btn.closest("li");
  const name = li.querySelector(".participant-name-container").textContent;

  li.classList.add("approved");
  li.dataset.status = "approved";
  li.querySelector(".participant-actions").innerHTML = `
    <button class="mute-btn"><i class="fa-solid fa-microphone"></i></button>
    <button class="kick-btn"><i class="fa-solid fa-user-minus"></i></button>
  `;

  const videoBox = document.createElement("div");
  videoBox.className = "video-box";
  videoBox.innerHTML = `<div class='simulated-video'>${name} Video Live</div>`;
  videos.appendChild(videoBox);

  showNotification(name + " joined");
}

function rejectUser(btn) {
  const li = btn.closest("li");
  li.remove();
  showNotification("Request rejected", "error");
}

function kickUser(btn) {
  const li = btn.closest("li");
  const name = li.querySelector(".participant-name-container").textContent;

  if (confirm("Kick " + name + "?")) {
    li.remove();
    document.getElementById(li.dataset.userId + "VideoBox")?.remove();
    showNotification(name + " removed", "error");
  }
}

/* =========================
   CHAT
========================= */
function toggleChat() {
  chatSection.classList.toggle("hidden");
}

document.getElementById("chatForm").onsubmit = (e) => {
  e.preventDefault();
  const msg = chatInput.value.trim();
  if (!msg) return;

  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<strong>${isHostMode ? "You (Host)" : "You"}:</strong> ${msg}`;

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  chatInput.value = "";
};

/* =========================
   RECORDING
========================= */
recordBtn.onclick = async () => {
  if (!isHostMode) return;

  if (!recorder || recorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: true
    });

    recorder = new MediaRecorder(stream);
    chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "recording.webm";
      a.click();
    };

    recorder.start();
    startTimer();
    alert("Recording started");
  } else {
    recorder.stop();
    stopTimer();
    alert("Recording stopped");
  }
};

function startTimer() {
  let sec = 0;
  recordingTimerInterval = setInterval(() => {
    sec++;
    timerDisplay.textContent =
      String(Math.floor(sec / 60)).padStart(2, "0") + ":" + String(sec % 60).padStart(2, "0");
  }, 1000);
}

function stopTimer() {
  clearInterval(recordingTimerInterval);
  timerDisplay.textContent = "00:00";
}

/* =========================
   SCREENSHOT
========================= */
screenshotBtn.onclick = () => {
  html2canvas(videos).then(canvas => {
    const link = document.createElement("a");
    link.download = "screenshot.png";
    link.href = canvas.toDataURL();
    link.click();
  });
};

/* =========================
   COPY CODE
========================= */
function copyCode() {
  const code = document.getElementById("meetingCode").textContent;
  navigator.clipboard.writeText(code);
  alert("Code Copied: " + code);
}

/* =========================
   SHARE MODAL
========================= */
function hideShareModal() {
  shareModal.classList.add("hidden");
}

/* =========================
   END CALL
========================= */
endCallControl.onclick = () => {
  if (confirm("Leave meeting?")) {
    location.href = "/";
  }
};

/* =========================
   TOAST
========================= */
function showNotification(msg, type = "success") {
  const toast = joinNotification;
  toast.querySelector("span").textContent = msg;

  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 3000);
}

/* =========================
   LOGOUT
========================= */
function logout() {
  location.href = "/";
}

</script>
</body>
</html>
